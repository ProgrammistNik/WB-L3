<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WarehouseControl</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    button { margin: 4px; }
    input { margin: 4px; }
    .item-block { padding: 10px; border: 1px solid #ddd; margin-bottom: 10px; }
  </style>
</head>
<body>

<h1>WarehouseControl</h1>

<!-- LOGIN -->
<h2>Login</h2>
<select id="role">
  <option value="admin">Admin</option>
  <option value="manager">Manager</option>
  <option value="viewer">Viewer</option>
</select>
<button onclick="login()">Login</button>
<p id="loginStatus" style="color: green;"></p>

<hr>

<!-- ADD ITEM -->
<div id="addItem" style="display:none;">
  <h3>Add Item</h3>
  <input id="newName" placeholder="Name">
  <input id="newQty" placeholder="Quantity" type="number">
  <button onclick="addItem()">Add</button>
</div>

<hr>

<!-- ITEMS -->
<h2>Items</h2>
<button onclick="loadItems()">Reload</button>
<div id="items"></div>

<script>
let token = ""
let userRole = ""

// LOGIN FUNCTION
function login() {
    let role = document.getElementById("role").value
    userRole = role

    fetch("/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({username: role, password: "x"})
    })
    .then(r => r.json())
    .then(d => {
        token = d.token
        document.getElementById("loginStatus").textContent = "Logged in as: " + role

        // показать кнопку Добавить только для ролей с правами
        if (role === "admin" || role === "manager") {
            document.getElementById("addItem").style.display = "block"
        } else {
            document.getElementById("addItem").style.display = "none"
        }

        loadItems()
    })
}

// LOAD ITEMS
function loadItems() {
    let headers = {}
    if (token) headers.Authorization = "Bearer " + token

    fetch("/items", { headers })
        .then(r => {
            if (!r.ok) return []  // если нет прав
            return r.json()
        })
        .then(d => renderItems(d))
        .catch(() => renderItems([]))
}

// RENDER ITEMS
function renderItems(items) {
    const container = document.getElementById("items")
    container.innerHTML = ""

    items.forEach(it => {
        const div = document.createElement("div")
        div.className = "item-block"

        div.innerHTML = `
            <b>ID:</b> ${it.id}<br>
            <b>Name:</b> ${it.name}<br>
            <b>Quantity:</b> ${it.quantity}<br>
            <b>Updated:</b> ${it.updated_at}<br><br>
        `

        // HISTORY BUTTON
        const historyBtn = document.createElement("button")
        historyBtn.textContent = "History"
        historyBtn.onclick = () => loadHistory(it.id)
        div.appendChild(historyBtn)

        // EDIT (admin, manager)
        if (userRole === "admin" || userRole === "manager") {
            const editBtn = document.createElement("button")
            editBtn.textContent = "Edit"
            editBtn.onclick = () => editItem(it)
            div.appendChild(editBtn)
        }

        // DELETE (admin)
        if (userRole === "admin") {
            const delBtn = document.createElement("button")
            delBtn.textContent = "Delete"
            delBtn.onclick = () => deleteItem(it.id)
            div.appendChild(delBtn)
        }

        container.appendChild(div)
    })
}

// ADD ITEM
function addItem() {
    const name = document.getElementById("newName").value
    const qty = parseInt(document.getElementById("newQty").value)

    if (!name || isNaN(qty)) return alert("Enter valid name and quantity")

    fetch("/items", {
        method: "POST",
        headers: {
            Authorization: "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({name, quantity: qty})
    })
    .then(() => loadItems())
}

// EDIT ITEM
function editItem(item) {
    const newName = prompt("New name:", item.name)
    const newQty = parseInt(prompt("New qty:", item.quantity))

    if (!newName || isNaN(newQty)) return

    fetch("/items/" + item.id, {
        method: "PUT",
        headers: {
            Authorization: "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({name: newName, quantity: newQty})
    })
    .then(() => loadItems())
}

// DELETE ITEM
function deleteItem(id) {
    if (!confirm("Delete item?")) return

    fetch("/items/" + id, {
        method: "DELETE",
        headers: {Authorization: "Bearer " + token}
    })
    .then(() => loadItems())
}

// LOAD HISTORY
function loadHistory(id) {
    fetch("/items/" + id + "/history", {
        headers: {Authorization: "Bearer " + token}
    })
    .then(r => r.json())
    .then(data => {
        alert("History:\n\n" + JSON.stringify(data, null, 2))
    })
}
</script>

</body>
</html>
